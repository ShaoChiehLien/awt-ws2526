<!doctype html>
<html>
<head>
<title>Twitch MIMUC</title>
<style>
canvas { display: none; }
</style>
</head>
<body>
<div>
    <h2>Anchor:</h2>
    <button id="start-stream">start streaming</button>
    <button id="stop-stream">stop streaming</button>
    <p id="message">
        Streaming: OFF
    </p>
    <video id="anchor" autoplay></video>
    <canvas id="capture" width="640" height="480"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
<script>
if (!navigator.mediaDevices) { // navigator is a global object for working with media streams
    document.body.textContent = 'Cannot use media devices.'
}
const socket = io()

// use MediaDevices API
// docs: https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia
let video = document.getElementById('anchor')
// request access to the camera and then set the video source to the camera stream
navigator.mediaDevices.getUserMedia({video: true})
.then(stream => { video.srcObject = stream })
.catch(error => {
    document.body.textContent = 'Could not access the camera. Error: ' + error.name
})

// button events
document.getElementById('start-stream').addEventListener('click', () => startStream())
document.getElementById('stop-stream').addEventListener('click', () => stopStream())

// render processing: draw the cideo frame to a canva first and then send it
let canvas = document.getElementById('capture')
// canvas.getContext('2d') gives you a 2D rendering context, which provides drawing
// functions like drawImage to draw image on canvas
let context = canvas.getContext('2d')
 // stream store the ID of the interval (infinite loop) so we can later stop it
let stream = null
const startStream = () => {
    if (stream) {return}
    document.getElementById("message").innerText = 'Streaming: ON'
    stream = setInterval(() => {
        context.drawImage(video, 0, 0, 640, 480);
        socket.emit('streaming', canvas.toDataURL('image/webp'))
    }, 40)
}
const stopStream = () => {
    if (!stream) {return}
    document.getElementById("message").innerText = 'Streaming: OFF'
    clearInterval(stream) // stop the interval
    stream = null // reset stream variable so we can create a new one next time we call startStream
}
</script>
</body>
</html>
